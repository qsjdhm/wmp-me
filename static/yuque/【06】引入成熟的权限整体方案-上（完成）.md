# 【06】引入成熟的权限整体方案-上（完成）

## 背景
前提：阅读本篇文章之前请先阅读vue-element-admin的权限相关文档
权限控制是每个系统都会使用的，简单的会牵扯到用户、角色、功能权限；复杂的会牵扯到用户、用户组、公司、机构、角色、功能权限、数据权限。但是对于一个通用型的前端框架，第一步要做的就是是用户、角色、功能权限的实现。
在使用过程中，一般情况是管理员对角色分配用户、对角色绑定功能权限。然后具体用户在登录自己的账号之后，进入系统只能看到自己被分配的功能（菜单、页面、元素），另外由于我们的系统是基于浏览器，所以我们还需要过滤用户在地址栏随意输入path实现跳转的方式。
## 实际遇到的问题
接下来我们就先讲一下我们在开发的过程中遇到的问题
### 问题
我们系统常规逻辑应该是在src\router\index.js创建对应的页面的路由之后，再在setting中点击“更新权限表”（因为在给角色分配资源时，一个用户是有多个角色，每个角色都有不同的菜单、页面、按钮权限，所以需要对每个角色对应的资源去重&取合集问题，所以后台需要有角色与资源有id关系的对应，方便后台去重&取合集操作），再到角色管理下给角色分配新的菜单、页面、元素权限，重新登录后就可以看到新增的路由页面，**但是！！！有时候后端恰巧也在开发权限、用户管理功能，导致没法配置**。这个时候在开发的过程中从菜单看不到页面，就没法进行开发（尴尬）
### 前端开发需求
这个时候我们前端开发的需求是：自己在src\router\index.js创建对应的页面路由之后，重新登录系统后就能立马看到新增的菜单页面并进行页面的开发。
## 整体设计
接下来我们揣着问题看设计
![权限流程图.png](https://cdn.nlark.com/yuque/0/2020/png/634279/1586497733695-2b2701df-d42f-4deb-9c5f-c978cec9c182.png#align=left&display=inline&height=2183&name=%E6%9D%83%E9%99%90%E6%B5%81%E7%A8%8B%E5%9B%BE.png&originHeight=2183&originWidth=1135&size=255715&status=done&style=none&width=1135)
### 第一步：系统路由初始设计
#### 思路
src\router\index.js是系统的路由索引文件，它包含了两种级别的路由：框架路由、业务路由
框架路由：login、welcome、redirect、401、404（不受权限控制）
业务路由：比如文件管理、客户管理、应用功能管理等（会受到权限控制）
在系统init的时候，会把框架路由加载到router中，业务路由会在路由守卫逻辑中判断当前系统是不是有业务路由，如果没有就会通过router.addRoutes方法添加到router中。
### 第二步：用户登录设计
#### 思路

1. 调后台接口进行用户登录
1. 处理“记住登录名”逻辑，保存到cookie中，并在localStorage中设置checked属性为true方便下次进入登录页自动选中“记住登录名”复选框
1. 获取到登录返回的数据后，将后台返回的Admin-Token、Admin-RefreshToken、Admin-ExpiresIn存储到sessionStorage中（因为在发生http请求是，拦截器会获取用户的token在每次http请求是带上）
1. 调后台接口获取用户的信息，会获取所属部门、所属类型等数据
1. 调后台接口获取此用户拥有的权限
1. 如果是生产环境，把用户的权限存储到Admin-Authority中，在走路由守卫逻辑的时候使用
1. 如果是开发环境，就将后台返回的权限数据再次加工，使其包含菜单、页面、元素的相关属性，再把加工后的权限数据存储到Admin-Authority中，在走路由守卫逻辑的时候使用
1. 跳转到welcome页面
#### 总结
经过以上步骤可以看到接下来就会跳转到welcome页面，在跳转页面的时候，系统路由守卫就会介入，并且会对路由path进行校验，符合条件next，不符合404或401
#### 相关代码

- src\views\login\目录下为登录相关代码
- src\settings.js登录时通过validAuth区别走开发环境逻辑还是生产环境逻辑
- src\utils\generateRouter.js为加工权限的工具类方法
- src\utils\request.js为请求中间件拦截器
### 第三步：系统路由守卫设计
#### 思路
路由守卫需要对以下情景进行验证

1. 已经登入到系统中，但使用者手动清除了系统保存的token等信息，会造成请求接口缺失token的错误
1. 在浏览器地址栏随便输入一些path或者输入不属于此用户但可以进入页面的path，造成不属于此用户的功能暴露
1. 为了方便开发，需要对每个页面进行访问

解决步骤

1. 对系统中是否存在token信息进行验证
  1. 不存在：跳转登录页
  1. 存在：获取store中permission.routes，判断是不是空数组（通过判断是不是空数组来得知是不是第一次登录到系统）
    1. 空数组：就代表第一次登录系统，需要把业务路由添加到主路由中，在跳转到本次要跳转的path中（一般第一次登录都是跳转welcome页面）
    1. 不是空数组：根据validAuth验证当前是不是开发环境
      1. 是开发环境：next
      1. 不是开发环境：还需要继续验证当前要跳转的路由是不是此用户所拥有的path
        1. 拥有：next
        1. 不拥有：代表用户自己在浏览器地址栏乱写的path路径，跳404
#### 总结
路由守卫一部分是跳转页面时对权限的验证，避免由于用户不正当操作造成页面不友好的500等报错信息；另一部分是对首次登录时，对系统业务路由和框架路由合并初始化（数据会在store中保存起来），这样左侧菜单才能通过store中的permission.routes进行渲染菜单等。
**后续会考虑直接拿用户拥有的权限路由来初始化权限！**
#### 相关代码

- src\permission.js路由守卫代码
- src\utils\generateRouter.js为加工权限的工具类方法
- src\store\modules\permission.js  store保存的权限相关数据，供渲染菜单使用
### 第四步：左侧菜单设计
#### 思路
先了解下两个变量承载的是什么数据

- store中的permission.routes也就是src\store\getters.js中的permission_routes：它存放了系统中所有的业务路由（不区分是不是受用户权限限制）
- sessionStorage的Admin-Authority：它存放了此用户才拥有的权限



#### 实现方式

1. 在src\layout\components\Sidebar\index.vue中去遍历permission_routes
1. 在src\layout\components\Sidebar\SidebarItem.vue中根据每次渲染的item全路径来判断是不是在Admin-Authority中，如果不存在，就表示此菜单不属于此用户，直接不显示，存在就渲染出来
#### 总结
遍历所有业务路由数据（permission_routes），再一个个判断item的path是不是存在Admin-Authority中，就完事了。
**后续会考虑直接拿用户拥有的权限路由来渲染菜单！**
#### 相关代码

- src\layout\components\Sidebar菜单相关代码
- src\store\getters.js保存在store中的系统所有业务路由数据
### 第五步：TagsView设计
#### 总结
tagsview的逻辑和vue-element-admin中的逻辑基本一致，只改变了编写路由时的一个变量：

- vue-element-admin中是noCache: true // 不会被 <keep-alive> 缓存
- 我们是cache: false // 不会被 <keep-alive> 缓存

详细代码请看src\router\index.js
#### 相关代码

- src\layout\components\TagsView快捷标签代码
- src\store\modules\tagsView.js store中保存的显示和缓存的tagsview数据
- src\store\getters.js
- src\router\index.js路由定义
- src\lang多语言
### 第六步：AppMain设计
#### 总结
appmain的逻辑和vue-element-admin中的逻辑基本一致，请参考vue-element-admin的逻辑
#### 相关代码

- src\layout\components\AppMain
- src\store\modules\tagsView.js store中保存的显示和缓存的tagsview数据
### 第七步：生产环境部署设计
上述5步基本是解决了开发时和系统整体框架的逻辑，那么我们在系统中设置了一个开关：src\settings.js的validAuth来表示是开发环境还是生产环境，从而判断走不走权限判断。
另外，还有一点在[https://www.yuque.com/emu83w/fpm1c8/trsmq1#W6dXv](https://www.yuque.com/emu83w/fpm1c8/trsmq1#W6dXv)这里提到会在页面的setting中点击“更新权限表”，才能把开发时新创建的路由保存到后端供后端处理用户对多角色，多角色对多权限的问题。
如图：
![image.png](https://cdn.nlark.com/yuque/0/2020/png/634279/1586428075054-a97950dc-2d90-4148-90ec-098b497370a4.png#align=left&display=inline&height=535&name=image.png&originHeight=535&originWidth=531&size=20577&status=done&style=none&width=531)
所以我们还得在这里看一下“更新权限表”的实现逻辑，具体代码在这里src\layout\components\Settings\index.vue的updatePermissions方法，可以看到会把系统所有的业务路由权限数据进行层级优化、处理特殊字段、生成页面按钮等操作后，调用接口把路由数据保存到后端。
## 后续
在会给大家介绍怎么迁移整套权限到vt-mg中台代码库。
在会给大家介绍开发的流程是什么。
### 可优化点
**由于目前权限还是采用用户拥有的权限和系统全部业务权限比对，来渲染菜单和路由守卫的验证，不太高级。所以还有可优化的空间，可优化内容如下：**

1. **路有守卫中验证是否第一次登录的那块代码改为可区分开发环境还是生产环境**
  1. **开发环境全部next**
  1. **生产环境会拿登录时保存到Admin-Authority中的用户拥有的权限来初始化系统，并把用户拥有的权限存到store的permission.routes中**
2. **菜单渲染改为直接从store的permission.routes中进行渲染菜单项即可**

进行了以上两个优化之后，可以达到如下效果：

1. 开发环境下快速创建router，立马就能开发页面
1. 生产环境下从前端渲染的菜单是由用户所拥有的权限列表渲染，避免不高级的比对操作来渲染菜单
